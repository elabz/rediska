x-health-defaults: &health_defaults
  interval: 10s
  timeout: 5s
  retries: 10
  start_period: 30s

services:
  rediska-nginx:
    image: nginx:1.27-alpine
    container_name: rediska-nginx
    depends_on:
      rediska-web:
        condition: service_started
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx/rediska.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    networks: [rediska-net]
    restart: unless-stopped

  rediska-web:
    build: ./apps/web
    container_name: rediska-web
    environment:
      - CORE_API_URL=http://rediska-core:8000
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - BASE_URL=${BASE_URL}
    networks: [rediska-net]
    restart: unless-stopped
    healthcheck:
      <<: *health_defaults
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000/', (r) => process.exit(r.statusCode === 200 ? 0 : 1))\""]

  rediska-core:
    build: ./services/core
    container_name: rediska-core
    environment:
      - MYSQL_URL=${MYSQL_URL}
      - REDIS_URL=${REDIS_URL}
      - ELASTIC_URL=${ELASTIC_URL}
      - ATTACHMENTS_PATH=${ATTACHMENTS_PATH}
      - BACKUPS_PATH=${BACKUPS_PATH}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}

      - INFERENCE_URL=${INFERENCE_URL}
      - INFERENCE_MODEL=${INFERENCE_MODEL}
      - INFERENCE_API_KEY=${INFERENCE_API_KEY}
      - EMBEDDINGS_URL=${EMBEDDINGS_URL}
      - EMBEDDINGS_MODEL=${EMBEDDINGS_MODEL}
      - EMBEDDINGS_API_KEY=${EMBEDDINGS_API_KEY}

      - PROVIDER_REDDIT_ENABLED=${PROVIDER_REDDIT_ENABLED}
      - PROVIDER_REDDIT_CLIENT_ID=${PROVIDER_REDDIT_CLIENT_ID}
      - PROVIDER_REDDIT_CLIENT_SECRET=${PROVIDER_REDDIT_CLIENT_SECRET}
      - PROVIDER_REDDIT_REDIRECT_URI=${PROVIDER_REDDIT_REDIRECT_URI}
      - PROVIDER_REDDIT_USER_AGENT=${PROVIDER_REDDIT_USER_AGENT}

      - PROVIDER_RATE_QPM_DEFAULT=${PROVIDER_RATE_QPM_DEFAULT}
      - PROVIDER_RATE_CONCURRENCY_DEFAULT=${PROVIDER_RATE_CONCURRENCY_DEFAULT}
      - PROVIDER_RATE_BURST_FACTOR=${PROVIDER_RATE_BURST_FACTOR}

      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}
    volumes:
      - ${ATTACHMENTS_PATH:-/var/lib/rediska/attachments}:${ATTACHMENTS_PATH:-/var/lib/rediska/attachments}
      - ${BACKUPS_PATH:-/var/lib/rediska/backups}:${BACKUPS_PATH:-/var/lib/rediska/backups}
    networks: [rediska-net]
    restart: unless-stopped
    depends_on:
      rediska-mysql:
        condition: service_healthy
      rediska-redis:
        condition: service_healthy
      rediska-elasticsearch:
        condition: service_healthy
    healthcheck:
      <<: *health_defaults
      test: ["CMD-SHELL", "curl -sf http://localhost:8000/healthz || exit 1"]

  rediska-worker:
    build:
      context: ./services
      dockerfile: worker/Dockerfile
    container_name: rediska-worker
    depends_on:
      rediska-core:
        condition: service_healthy
      rediska-redis:
        condition: service_healthy
    environment:
      - MYSQL_URL=${MYSQL_URL}
      - REDIS_URL=${REDIS_URL}
      - ELASTIC_URL=${ELASTIC_URL}
      - ATTACHMENTS_PATH=${ATTACHMENTS_PATH}
      - BACKUPS_PATH=${BACKUPS_PATH}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}

      - INFERENCE_URL=${INFERENCE_URL}
      - INFERENCE_MODEL=${INFERENCE_MODEL}
      - INFERENCE_API_KEY=${INFERENCE_API_KEY}
      - EMBEDDINGS_URL=${EMBEDDINGS_URL}
      - EMBEDDINGS_MODEL=${EMBEDDINGS_MODEL}
      - EMBEDDINGS_API_KEY=${EMBEDDINGS_API_KEY}

      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}

      - PROVIDER_REDDIT_ENABLED=${PROVIDER_REDDIT_ENABLED}
      - PROVIDER_REDDIT_CLIENT_ID=${PROVIDER_REDDIT_CLIENT_ID}
      - PROVIDER_REDDIT_CLIENT_SECRET=${PROVIDER_REDDIT_CLIENT_SECRET}
      - PROVIDER_REDDIT_REDIRECT_URI=${PROVIDER_REDDIT_REDIRECT_URI}
      - PROVIDER_REDDIT_USER_AGENT=${PROVIDER_REDDIT_USER_AGENT}

      - PROVIDER_RATE_QPM_DEFAULT=${PROVIDER_RATE_QPM_DEFAULT}
      - PROVIDER_RATE_CONCURRENCY_DEFAULT=${PROVIDER_RATE_CONCURRENCY_DEFAULT}
      - PROVIDER_RATE_BURST_FACTOR=${PROVIDER_RATE_BURST_FACTOR}
    volumes:
      - ${ATTACHMENTS_PATH:-/var/lib/rediska/attachments}:${ATTACHMENTS_PATH:-/var/lib/rediska/attachments}
      - ${BACKUPS_PATH:-/var/lib/rediska/backups}:${BACKUPS_PATH:-/var/lib/rediska/backups}
    networks: [rediska-net]
    restart: unless-stopped

  rediska-beat:
    build:
      context: ./services
      dockerfile: worker/Dockerfile
    container_name: rediska-beat
    command: ["celery", "-A", "rediska_worker.celery_app", "beat", "-l", "INFO"]
    depends_on:
      rediska-redis:
        condition: service_healthy
      rediska-core:
        condition: service_healthy
    environment:
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}
      - MYSQL_URL=${MYSQL_URL}
      - REDIS_URL=${REDIS_URL}
      - ELASTIC_URL=${ELASTIC_URL}
      - ATTACHMENTS_PATH=${ATTACHMENTS_PATH}
      - BACKUPS_PATH=${BACKUPS_PATH}
    volumes:
      - ${ATTACHMENTS_PATH:-/var/lib/rediska/attachments}:${ATTACHMENTS_PATH:-/var/lib/rediska/attachments}
      - ${BACKUPS_PATH:-/var/lib/rediska/backups}:${BACKUPS_PATH:-/var/lib/rediska/backups}
    networks: [rediska-net]
    restart: unless-stopped

  rediska-redis:
    image: redis:7-alpine
    container_name: rediska-redis
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - rediska_redis_data:/data
    networks: [rediska-net]
    restart: unless-stopped
    healthcheck:
      <<: *health_defaults
      test: ["CMD", "redis-cli", "ping"]

  rediska-mysql:
    image: mysql:8.4
    container_name: rediska-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - rediska_mysql_data:/var/lib/mysql
    networks: [rediska-net]
    restart: unless-stopped
    healthcheck:
      <<: *health_defaults
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${MYSQL_ROOT_PASSWORD}"]

  rediska-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.3
    container_name: rediska-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    volumes:
      - rediska_es_data:/usr/share/elasticsearch/data
    networks: [rediska-net]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

networks:
  rediska-net:

volumes:
  rediska_mysql_data:
  rediska_es_data:
  rediska_redis_data:
